{"version":3,"kind":"Notebook","sha256":"001a8a12fa31a24e5416aefebf13e5ab928575a233c68661b0916d4eead25c79","slug":"external-notebooks.esa-cci.esa-climate-toolbox.notebooks.advanced-functionality.ect-failure-reporting","location":"/external_notebooks/esa-cci/esa-climate-toolbox/notebooks/Advanced_Functionality/2-ECT_Failure-reporting.ipynb","dependencies":[],"frontmatter":{"title":"Failure reporting in the ESA Climate Toolbox","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"github":"https://github.com/esa-cci/cci-notebook-viewers","subject":"CCI Examples","numbering":{"title":{"offset":5}},"source_url":"https://github.com/esa-cci/cci-notebook-viewers/blob/main/external_notebooks/esa-cci/esa-climate-toolbox/notebooks/Advanced_Functionality/2-ECT_Failure-reporting.ipynb","edit_url":"https://github.com/esa-cci/cci-notebook-viewers/edit/main/external_notebooks/esa-cci/esa-climate-toolbox/notebooks/Advanced_Functionality/2-ECT_Failure-reporting.ipynb","exports":[{"format":"ipynb","filename":"2-ECT_Failure-reporting.ipynb","url":"/cci-toolbox-usage-viewers/build/2-ECT_Failure-report-66edf84ed87db2aafbfec010ac645210.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The ESA Climate Toolbox provides a mechanism whereby unrecoverable failures can be reported automatically to an external server. The user must explicitly consent to this data sharing before it can be activated.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"mZjBEqQymO"}],"key":"ZwXaIbvG5Y"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"This notebook demonstrates the mechanism by setting up a simple local reporting server, which receives failure reports and writes them to a file. The notebook then activates automated failure reporting and deliberately raises an error from the toolbox. Finally, the server’s log file is shown to demonstrate that the report was received and logged.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"kgLFVlud3U"}],"key":"LQfQQQBoru"}],"key":"olupPX8r2e"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Import some necessary classes and modules, including the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ywFO3tyV46"},{"type":"inlineCode","value":"FailureReporter","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"By8tVSGDsZ"},{"type":"text","value":" class.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TUQYBtqiu5"}],"key":"h7t43HA1pZ"}],"key":"epXP1P2Z9t"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import datetime\nimport json\nimport pathlib\nfrom http.server import BaseHTTPRequestHandler\nfrom http.server import HTTPServer\nimport multiprocessing\nfrom esa_climate_toolbox.util.reporting import FailureReporter","key":"xmT38mc1Du"},{"type":"outputs","id":"mIcDO5jiKm8yf39mbLoVE","children":[],"key":"w11ryhmTE1"}],"key":"i3PGXwORhS"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define a minimal server which will receive failure reports, and start it in the background.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bhPlkbAi01"}],"key":"ccc0ydPlkj"}],"key":"uXrMx6vmiZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"log_path = pathlib.Path(\"server-log.txt\")\n\nclass ReportRequestHandler(BaseHTTPRequestHandler):\n\n    def do_POST(self):\n        self.send_response(200)\n        self.send_header(\"Content-Type\", \"text/plain\")\n        self.end_headers()\n        content_length = int(self.headers.get(\"Content-Length\", 0))\n        content = self.rfile.read(content_length).decode(\"utf-8\")\n        data = json.loads(content)\n        with open(log_path, \"a\") as fh:\n            fh.write(datetime.datetime.now(datetime.UTC).isoformat() + \"\\n\")\n            for k, v in data.items():\n                fh.write(k + \":\\n\")\n                fh.write(\"\\n\".join(v) if isinstance(v, list) else str(v) + \"\\n\")\n            fh.write(\"\\n\")\n        self.wfile.write(\"OK\".encode(\"utf-8\"))\n\nserver = HTTPServer((\"127.0.0.1\", 9898), ReportRequestHandler)\n\ndef start_server():\n    server.serve_forever()\n\nlog_path.unlink(missing_ok=True)\nprocess = multiprocessing.Process(target=start_server)\nprocess.start()","key":"SGwtXZP0ez"},{"type":"outputs","id":"j9Lm8RVKnh_GsgHKvFjdw","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"127.0.0.1 - - [04/Dec/2025 11:53:17] \"POST / HTTP/1.1\" 200 -\n"},"children":[],"key":"uN3BKDNjrN"}],"key":"qKafz7l2JB"}],"key":"gDV6WyYzmM"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create and activate a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dcUj3shaYw"},{"type":"inlineCode","value":"FailureReporter","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zB1FIoliJl"},{"type":"text","value":", which will automatically detect and report any unhandled exceptions involving the ESA Climate Toolbox. The URL of the server which receives the reports can be passed as a parameter or using the environment variable ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yQFXLnVuqp"},{"type":"inlineCode","value":"ESA_CLIMATE_TOOLBOX_FAILURE_REPORTING_SERVER_URL","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Pqih1P40JT"},{"type":"text","value":". The user is asked for their explicit consent before the reporter is activated.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sef3FzH9Vw"}],"key":"IJdZi0ccMx"}],"key":"QVHKplY6gt"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"reporter = FailureReporter(\"http://localhost:9898\")\nreporter.activate()","key":"eh41JlTVIA"},{"type":"outputs","id":"HqL8NCqtW5YedLRiYZ-HM","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Please enter YES below to consent to reporting.\n"},"children":[],"key":"vSEPOI3Jsb"},{"type":"output","jupyter_data":{"name":"stdin","output_type":"stream","text":" YES\n"},"children":[],"key":"APlA5dRB9x"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Activating reporting.\nIPython reporting activated.\n"},"children":[],"key":"GKj2uslXpQ"}],"key":"tbYrEwHR22"}],"key":"VsTRVx15oD"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now test the functionality. The ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"M3SctN9KY4"},{"type":"inlineCode","value":"FailureReporter","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PymAKb3zzO"},{"type":"text","value":" class provides a method called ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YUUTPT2XUm"},{"type":"inlineCode","value":"raise_error","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"N1TM2m4GO8"},{"type":"text","value":" to deliberately trigger an error within the toolbox code for testing purposes.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZYYV3INpGH"}],"key":"MsO7vfJXXg"}],"key":"oTPkIRVJpc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"FailureReporter.raise_error()","key":"tkGjUu5iY3"},{"type":"outputs","id":"vl9w1Tx5pe3msD3kNqbMG","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Reporting exception.\n"},"children":[],"key":"uCywieJrlY"},{"type":"output","jupyter_data":{"ename":"Exception","evalue":"This is an error to test the reporting functionality.","output_type":"error","traceback":"\u001b[0;31m---------------------------------------------------------------------------\u001b[0m\n\u001b[0;31mException\u001b[0m                                 Traceback (most recent call last)\nCell \u001b[0;32mIn[4], line 1\u001b[0m\n\u001b[0;32m----> 1\u001b[0m \u001b[43mFailureReporter\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mraise_error\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\nFile \u001b[0;32m~/projects/esa-cci/esa-climate-toolbox/esa_climate_toolbox/util/reporting.py:89\u001b[0m, in \u001b[0;36mFailureReporter.raise_error\u001b[0;34m()\u001b[0m\n\u001b[1;32m     87\u001b[0m \u001b[38;5;129m@staticmethod\u001b[39m\n\u001b[1;32m     88\u001b[0m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;21mraise_error\u001b[39m():\n\u001b[0;32m---> 89\u001b[0m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mException\u001b[39;00m(\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mThis is an error to test the reporting functionality.\u001b[39m\u001b[38;5;124m\"\u001b[39m)\n\n\u001b[0;31mException\u001b[0m: This is an error to test the reporting functionality."},"children":[],"key":"Cyj0FoCP8G"}],"key":"CBr65rcIjl"}],"key":"kIwDWL0Aw2"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"For comparison, trigger an exception not involving the climate toolbox. This will still be reported in the notebook, but will not be reported to the server.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"y3mheAuj7J"}],"key":"S7EpUGx24b"}],"key":"OeyUBcWKmT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"1 / 0","key":"YT4yxPgznO"},{"type":"outputs","id":"8PbXAgZakxfql8tyLLtdQ","children":[{"type":"output","jupyter_data":{"ename":"ZeroDivisionError","evalue":"division by zero","output_type":"error","traceback":"\u001b[0;31m---------------------------------------------------------------------------\u001b[0m\n\u001b[0;31mZeroDivisionError\u001b[0m                         Traceback (most recent call last)\nCell \u001b[0;32mIn[5], line 1\u001b[0m\n\u001b[0;32m----> 1\u001b[0m \u001b[38;5;241;43m1\u001b[39;49m\u001b[43m \u001b[49m\u001b[38;5;241;43m/\u001b[39;49m\u001b[43m \u001b[49m\u001b[38;5;241;43m0\u001b[39;49m\n\n\u001b[0;31mZeroDivisionError\u001b[0m: division by zero"},"children":[],"key":"B5GuyWDNio"}],"key":"rYQoSK5eY4"}],"key":"KF94OL1AI4"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Show the contents of the server’s log file. Note that the exception from the climate toolbox is logged, but the other exception is not.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Es6c9JXaWn"}],"key":"BQfEtn3lo3"}],"key":"wRZTCKDFBz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"with open(log_path, \"r\") as fh:\n    for line in fh.readlines():\n        print(line, end=\"\")","key":"hIwfvf4UXv"},{"type":"outputs","id":"f3EwyJ_1ZosF8HIQMjDIp","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"2025-12-04T10:53:17.960178+00:00\ntoolbox-version:\n1.5.1.dev0\nexception-class:\nException\nexception-instance:\nException('This is an error to test the reporting functionality.')\ntraceback:\n  File \"/home/tonio/miniconda3/envs/ect/lib/python3.13/site-packages/IPython/core/interactiveshell.py\", line 3577, in run_code\n    exec(code_obj, self.user_global_ns, self.user_ns)\n    ~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n\n  File \"/tmp/ipykernel_16423/2859698634.py\", line 1, in <module>\n    FailureReporter.raise_error()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n\n  File \"/home/tonio/projects/esa-cci/esa-climate-toolbox/esa_climate_toolbox/util/reporting.py\", line 89, in raise_error\n    raise Exception(\"This is an error to test the reporting functionality.\")\n\n"},"children":[],"key":"fwry5soUYh"}],"key":"ttfMC5L6T7"}],"key":"QOMl0a0ls0"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Shut down the server.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"l3aomD2OgW"}],"key":"rI4rkVSeIs"}],"key":"UYRthlVcKg"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"process.kill()\nserver.socket.close()","key":"hw5xDiRBe1"},{"type":"outputs","id":"J565CER_RhPNohNiWqmi_","children":[],"key":"gniPUaBzkb"}],"key":"ucQ3KCIffF"}],"key":"Xz5bg1vt4N"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Using the ESA CCI Toolbox with the xcube Viewer","url":"/external-notebooks/esa-cci/esa-climate-toolbox/notebooks/advanced-functionality/ect-using-xcube-viewer","group":"Advanced Functionality"},"next":{"title":"Performance tests","url":"/external-notebooks/esa-cci/esa-climate-toolbox/notebooks/advanced-functionality/ect-performance","group":"Advanced Functionality"}}},"domain":"http://localhost:3000"}